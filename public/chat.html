<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat | Voxy</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="icon" type="image/png" sizes="32x32" href="public/images/logo-32x32.png" />
</head>
<body>
  <a href="index.html">
    <img src="public/images/logo.png" alt="Logo Voxy" class="logo-top-left" />
  </a>

  <div id="chat-container" class="container">
    <div id="chat-box" style="min-height: 300px; overflow-y: auto; padding: 10px;"></div>

    <div class="chat-input-area">
      <input id="user-input" type="text" placeholder="Digite sua resposta..." autocomplete="off" />
      <button onclick="sendMessage()">Enviar</button>
    </div>

    <button id="new-budget-btn" onclick="startNewBudget()">Novo or√ßamento</button>
  </div>

  <button id="theme-toggle">üåô</button>

  <script>
    let userId = null;
    const questions = [
      "ü§ñ Ol√°! Vamos fazer um or√ßamento para seu site. Qual o tipo de site? (institucional, loja, etc.)",
      "Quantas p√°ginas ter√°?",
      "Deseja design personalizado? (sim/n√£o)",
      "Precisa de integra√ß√£o com redes sociais ou pagamento? (sim/n√£o)"
    ];
    let step = 0;
    let answers = [];

    function addMessage(sender, text) {
      const chatBox = document.getElementById("chat-box");
      const msg = document.createElement("div");
      msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function sendMessage() {
      const inputEl = document.getElementById("user-input");
      const text = inputEl.value.trim();
      if (!text) return;

      addMessage("Voc√™", text);
      answers.push(text);
      inputEl.value = "";
      step++;

      if (step < questions.length) {
        setTimeout(() => addMessage("Bot", questions[step]), 500);
        return;
      }

      // Calcula or√ßamento
      const [tipo, paginasRaw, designRaw, integracoesRaw] = answers;
      const paginas = parseInt(paginasRaw, 10) || 0;
      const design = designRaw.trim().toLowerCase().startsWith("s");
      const integracoes = integracoesRaw.trim().toLowerCase().startsWith("s");
      const precoBase = 900 + (paginas * 300) + (design ? 600 : 0) + (integracoes ? 1000 : 0);

      // Simula salvar or√ßamento (pode ser seu backend)
      fetch("http://localhost:3000/api/budget", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: userId,
          tipo,
          paginas,
          design: design ? "sim" : "n√£o",
          integracoes: integracoes ? "sim" : "n√£o",
          price: precoBase
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("Erro na resposta do servidor");
        return res.json();
      })
      .then(data => {
        addMessage("Bot", `‚úÖ Or√ßamento salvo! ID ${data.id}.`);
        addMessage("Bot", `üí∞ Total: R$ ${precoBase},00.`);
        addMessage("Bot", `üìß Voc√™ receber√° um e-mail com o or√ßamento e m√©todos de pagamento.`);
        document.querySelector(".chat-input-area").style.display = "none";
        document.getElementById("new-budget-btn").style.display = "block";
      })
      .catch(err => {
        console.error(err);
        addMessage("Bot", "‚ùå Desculpe, houve um erro ao salvar seu or√ßamento.");
      });
    }

    function startNewBudget() {
      step = 0;
      answers = [];
      document.getElementById("chat-box").innerHTML = "";
      addMessage("Bot", questions[step]);
      document.querySelector(".chat-input-area").style.display = "flex";
      document.getElementById("new-budget-btn").style.display = "none";
      document.getElementById("user-input").focus();
    }

    // Tema escuro/claro
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      localStorage.setItem('dark-mode', isDark ? 'true' : 'false');
      themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    });

    window.addEventListener('DOMContentLoaded', () => {
      const isDark = localStorage.getItem('dark-mode');
      if (isDark === 'true' || (!isDark && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-mode');
        themeToggle.textContent = '‚òÄÔ∏è';
      }
      startNewBudget();
    });
  </script>
</body>
</html>
